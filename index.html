<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta content="981670883142-ngho0tscplngjfgcetj0k7kgekn59eaa.apps.googleusercontent.com"
		  name="google-signin-client_id">

	<link rel="apple-touch-icon" sizes="57x57" href="favicon/apple-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="favicon/apple-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="favicon/apple-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="favicon/apple-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="favicon/apple-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="favicon/apple-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="favicon/apple-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="favicon/apple-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-icon-180x180.png">
	<link rel="icon" type="image/png" sizes="192x192" href="favicon/android-icon-192x192.png">
	<link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="96x96" href="favicon/favicon-96x96.png">
	<link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
	<link rel="manifest" href="favicon/manifest.json">
	<meta name="msapplication-TileColor" content="#ffffff">
	<meta name="msapplication-TileImage" content="favicon/ms-icon-144x144.png">
	<meta name="theme-color" content="#ffffff">

	<link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="node_modules/font-awesome/css/font-awesome.css">
	<link rel="stylesheet" href="index.css">

	<title>Hash Teller</title>
</head>
<body>

<script>
	function previewImage() {
		var oFReader = new FileReader();
		oFReader.readAsDataURL(document.getElementById("file-chooser").files[0]);

		oFReader.onload = function (oFREvent) {
			document.getElementById("image-preview").src = oFREvent.target.result;
		};
	}

	function signinCallback(authResult) {
		document.querySelector('.navbar-welcome').innerHTML = 'Welcome, ' + authResult.w3.ig + '!';
		document.getElementById('signout').classList.remove("hidden-xl-down");
		document.getElementById('authorized-content').classList.remove("hidden-xl-down");
		document.getElementById('signin').classList.add("hidden-xl-down");

		if (authResult.Zi && authResult.Zi.id_token) {
			AWS.config.region = 'eu-west-1';
			// Add the Google access token to the Cognito credentials login map.
			AWS.config.credentials = new AWS.CognitoIdentityCredentials({
				IdentityPoolId: 'eu-west-1:3c8041e1-eb00-49d8-90b9-4f667b3e9757',
				Logins: {
					'accounts.google.com': authResult.Zi.id_token
				}
			});

			// Obtain AWS credentials
			AWS.config.credentials.get(function () {
				var bucketName = 'instagram-hastag-generator';
				var bucket = new AWS.S3({
					params: {
						Bucket: bucketName
					}
				});

				var fileChooser = document.getElementById('file-chooser');
				var button = document.getElementById('upload-button');
				var results = document.getElementById('results');
				var runLambda = document.getElementById('runLambda');
				var progressBar = document.getElementById('load-progress-bar');

				button.addEventListener('click', function () {
					var file = fileChooser.files[0];

					if (file) {
						var objKey = file.name;
						var params = {
							Key: objKey,
							ContentType: file.type,
							Body: file,
							ACL: 'public-read'
						};

						bucket.putObject(params).on('httpUploadProgress', function (progress) {
							var percent = Math.ceil((progress.loaded / progress.total) * 100);
							Object.assign(progressBar.style, {width: percent + '%'});
							progressBar.innerHTML = percent + '%';
						}).send(function (err, data) {
							var lambda = new AWS.Lambda();
							lambda.invoke({
								FunctionName: 'generate-tags-service-dev-generateTags',
								Payload: JSON.stringify({s3Key: objKey})
							}, function (err, data) {
								if (err) {
									console.error(err);
									return;
								}

								var tags = JSON.parse(JSON.parse(data.Payload))
									.map(function (t) {
										return '#' + t;
									})
									.join(' ');

								document.getElementById('output').innerHTML = tags;
								document.getElementById('output-wrap').classList.remove('hidden-xl-down');
							});

						});
					}
				}, false);
			});
		}
	}
</script>

<script>
	function signOut() {
		var auth2 = gapi.auth2.getAuthInstance();
		auth2.signOut().then(function () {
			document.location.href = "/";
		});
	}
</script>


<div class="container">
	<nav class="navbar navbar-toggleable-md navbar-inverse bg-inverse mb-3">
		<a class="navbar-brand" href="#">
			<img src="img/logo.png" width="30" height="30" class="d-inline-block align-top" alt="">
			Hash Teller
		</a>

		<div class="collapse navbar-collapse" id="navbarSupportedContent">
			<ul class="navbar-nav mr-auto">
				<li class="nav-item active">
					<a class="nav-link" href="https://github.com/AntonNarkevich/hash-teller-fe" target="_blank">
						<i class="fa fa-github-alt fa-inverse align-text-top" aria-hidden="true"></i>
						<span>GitHub</span>
					</a>
				</li>
			</ul>
			<ul class="navbar-nav">
				<li class="navbar-text navbar-welcome">
				</li>
				<li class="nav-item hidden-xl-down" id="signout">
					<a class="nav-link" href="#" onclick="signOut();">(Sign out)</a>
				</li>
			</ul>
		</div>
	</nav>

	<div class="jumbotron jumbotron-fluid content-wrap align-items-center d-flex">
		<div class="col-md-4 offset-md-4 mb-4" id="signin">
			<h4 class="text-center mb-3">Sign in</h4>

			<div class="g-signin2" data-theme="light" data-longtitle="true" data-width="auto"
				 data-onsuccess="signinCallback"></div>
		</div>

		<div class="col-md-8 offset-md-2 hidden-xl-down mb-4 align-self-start" id="authorized-content">
			<h2 class="text-center mb-3">Instagram <span class="tag">#</span>tags you were missing!</h2>
			<p class="mb-5">Don't know which tags to use? Let us help you! Upload it below and we'll find the perfect ones.
				It is free.
			</p>

			<div class="row align-items-center">
				<div class="col-md-4">
					<img src="img/image-placeholder.png" alt="image preview" id="image-preview"
						 class="img-thumbnail">
				</div>

				<div class="col-md-8">
					<div class="progress mb-2">
						<div class="progress-bar progress-bar-striped progress-purple progress-bar-animated"
							 role="progressbar" id="load-progress-bar"
							 aria-valuemax="100">
						</div>
					</div>

					<form class="form-inline">
						<input type="file" id="file-chooser" class="form-control-file" onchange="previewImage();">
						<button type="button" id="upload-button" class="btn btn-secondary col">Tell me tags</button>
					</form>
				</div>
			</div>
		</div>

		<div class="col-md-8 offset-md-2 hidden-xl-down" id="output-wrap">
			<h4>Here we go:</h4>
			<code id="output" class="d-block"></code>
		</div>
	</div>

	<div class="row">
		<div class="col-md-8 offset-md-2">
			<nav class="navbar navbar-toggleable-md bg-faded fixed-bottom justify-content-center">
				<small class="nav-text">Â© 2017, <a href="mailto:antonio.narkevich@gmail.com" target="_top">Antonio Narkevich</a></small>
			</nav>
		</div>
	</div>

</div>

	<script src="https://apis.google.com/js/platform.js" async defer></script>
	<script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.20.min.js"></script>

</body>
</html>